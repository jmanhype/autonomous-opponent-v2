# Prometheus Metrics Integration Guide

## Overview

The Autonomous Opponent VSM exposes comprehensive metrics in Prometheus format at the `/metrics` endpoint. This guide covers configuration, available metrics, and best practices for monitoring.

## Quick Start

### Basic Prometheus Configuration

Add to your `prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'autonomous_opponent'
    static_configs:
      - targets: ['localhost:4000']
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s
```

### Grafana Dashboard

Import the included dashboard or create your own focusing on:
- VSM subsystem health
- Variety flow rates
- Algedonic balance
- Cybernetic loop latencies

## Available Metrics

### VSM Subsystem Metrics

- `vsm_variety_absorbed{subsystem="s1"}` - Variety absorbed by each subsystem
- `vsm_variety_generated{subsystem="s1"}` - Variety generated by each subsystem
- `vsm_subsystem_health{subsystem="s1"}` - Health percentage (0-100)
- `vsm_operations_success{subsystem="s1"}` - Successful operations count
- `vsm_operations_failed{subsystem="s1"}` - Failed operations count

### Algedonic Signals

- `vsm_algedonic_pain` - Pain signal intensity (0-1)
- `vsm_algedonic_pleasure` - Pleasure signal intensity (0-1)
- `vsm_algedonic_balance` - Overall balance (-1 to 1)

### Cybernetic Loop Performance

- `vsm_cybernetic_loop_latency{loop="s1_to_s2"}` - Loop latency in milliseconds
- `vsm_feedback_cycles_total` - Total feedback cycles completed

### System Health

- `circuit_breaker_state{name="default"}` - Circuit breaker state (0=closed, 1=open, 2=half-open)
- `rate_limiter_requests_allowed` - Allowed requests
- `rate_limiter_requests_rejected` - Rejected requests

### Meta-Metrics

- `metrics_cardinality_total` - Number of unique metric series
- `metrics_response_size_bytes` - Size of metrics response
- `metrics_endpoint_up` - Metrics endpoint availability (always 1)

## Configuration Options

### Environment Variables

- `METRICS_AUTH_TOKEN` - Bearer token for authentication (optional)
- `METRICS_CORS_ENABLED` - Enable CORS headers (default: true)
- `METRICS_RATE_LIMIT` - Requests per minute limit (default: 10)

### Application Config

```elixir
config :autonomous_opponent_web,
  metrics_endpoint_auth_enabled: false,
  metrics_endpoint_auth_token: System.get_env("METRICS_AUTH_TOKEN"),
  metrics_endpoint_rate_limit: 10,
  metrics_endpoint_cors_enabled: true
```

## Production Deployment

### Security Considerations

1. **Authentication**: Enable auth in production:
   ```elixir
   config :autonomous_opponent_web,
     metrics_endpoint_auth_enabled: true,
     metrics_endpoint_auth_token: System.get_env("METRICS_AUTH_TOKEN")
   ```

2. **Network Security**: Use firewall rules to restrict access to Prometheus servers only

3. **Rate Limiting**: Built-in rate limiting prevents abuse

### Performance Optimization

1. **Cardinality Management**: Monitor `metrics_cardinality_total` to prevent explosion
2. **Scrape Interval**: 15-30 seconds recommended for production
3. **Retention**: Configure Prometheus retention based on cardinality

### High Availability

For distributed deployments:

1. **Prometheus Federation**:
   ```yaml
   - job_name: 'federate'
     honor_labels: true
     metrics_path: '/federate'
     params:
       'match[]':
         - '{job="autonomous_opponent"}'
   ```

2. **Multiple Scrapers**: Use Thanos or Cortex for long-term storage

## Alerting Rules

Example Prometheus alerts:

```yaml
groups:
  - name: vsm_alerts
    rules:
      - alert: AlgedonicPainHigh
        expr: vsm_algedonic_pain > 0.8
        for: 5m
        annotations:
          summary: "High pain signal detected"
          
      - alert: VarietyOverload
        expr: rate(vsm_variety_generated[5m]) > rate(vsm_variety_absorbed[5m]) * 2
        for: 10m
        annotations:
          summary: "Variety generation exceeding absorption"
          
      - alert: SubsystemUnhealthy
        expr: vsm_subsystem_health < 50
        for: 5m
        annotations:
          summary: "VSM subsystem health degraded"
```

## Troubleshooting

### No Metrics Available

If you see "No metrics available":
1. Check if Core.Metrics GenServer is running
2. Verify EventBus is publishing events
3. Check application logs for errors

### High Cardinality

If cardinality exceeds 10,000:
1. Review label usage in metric recording
2. Implement metric aggregation
3. Use recording rules in Prometheus

### Performance Issues

For slow metric exports:
1. Check ETS table size
2. Review metric retention settings
3. Consider metric sampling for high-volume series

## Integration with VSM Principles

The metrics system embodies VSM cybernetic principles:

1. **Variety Management**: Metrics compress system state for human comprehension
2. **Feedback Loops**: Real-time metrics enable cybernetic control
3. **Algedonic Signals**: Direct pain/pleasure metrics for urgent response
4. **Recursive Monitoring**: Meta-metrics monitor the monitoring system

## Future Enhancements

Planned improvements include:

1. **Distributed Aggregation**: CRDT-based metrics for multi-node deployments
2. **Predictive Metrics**: ML-based forecasting of system behavior
3. **Semantic Compression**: Neural-enhanced Bloom filters for cardinality reduction
4. **Z3n Integration**: Security metrics with network-origin tagging